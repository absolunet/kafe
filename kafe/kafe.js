/*                                                                                                             
                                                    .   ..  ..                                                 
                             ....',;;:::clccllodddoooddoolodddocllclolllodollccccc::;,'...                     
                   ..,;:codddollllcccc:;,,'','........   ....    ...........';:c:cllodddxxkxxdolc;'..          
          ..';:::ldxOOOkxd:............                                                   .;xocodxkkkxd;.      
      ,ldkkxolcldkk0XNKd;,..'xOxdc;''......                                        .....',,:ll;:ccl:,...:;     
     'Ol'',;:;;:ccdkO00Oxdc;':ldolcllc:::ol.                             .. ...'.',,';::;c:::::''........c.    
     dk'.,,,,;;;;,,;,',;:coolcccc:;cc;;,,',;,'....... ......   .   .........................        ..   :c.   
    .0d.cl:,.'..''.'',;,',,''...'....',''.''.'''....'.............    .                                  ,x.   
   .oK;.,clc;'...................................... ....                                                .xk.  
   lKOc'::;,,;,,'..... .                                                                               ....l.  
  xXd,';;,;:;'......                                                                            .    .     .:  
 .xKOxlc:;;,.'.............                                             .                 ..          .':,'.   
  .,xXd,,;:cccl:;;;,'.'....   .                         ..'.......','......                ...';::;;;;;:o'     
    'Ko.........',::ccccclooloolcc::,''''','.......................................';,;;;,;;:,'....    .:.     
    .0d...........     .......'',,;;;;:::::::::::;;;;:ccc:;::::,,,'...................                 ;c      
    .kx.............. .                                                                                :;      
     ,:........                                                                                       ;O'      
     ':........                                                                                     .oKd.      
     .xo'...                                                                                   ..,;:cccx:      
     ;xdxxxdlc:;,''.......                                                              ....',;:;;;,'.;d,      
     'kl:cc::cccllllllolccc:::;;;,''.....                                      .......'',,,;;,,,,'''..;d'      
     .xlcolc:c:;::;;;;,,,,,,,;;;;,,,,,''''''','','..'..............''''',,'''''''''''''''''''''.',,''.:d.      
     .llcodl:::::;;:;,,,;;,,,'''''''',''''....''',;,,'''''''''...'''.''..''..........''.'''',,',,,,''.:o.      
      ldclolc::::;;:;;;,,,,,,,,'','..''....'cdxkOO0OOxc,.....................'..'...'''',;,,,,,;,,,''':c.      
      :dclllc:c::;;;;;,,;;,,,,,''''..''..,oOKKKKKKKKKKK0xc'........................''''''',,,',,,,,,..::       
      'c:lkKKK00Ol;;:;::;;;;;,,,'.....':d0KKKK00K00KKKKKKKOl'.'...........':oddxxl'...'''''',,,,,,,,'.c:       
      .c;ckXXKKXKo;::;;;:;,,,,,,,'''';xKKK000KK0KKK0KK000KKKd'.''...''...:xKKKKKXd...''''''',,,',,,,''l;       
      .c;:xXXXKX0l;;;;,,,,,,,,,'''',lOKKK0KKK0KKKKKK00KK0KKK0d,........'cOKKKKKK0l...'''''''','',,,'.'c'       
       ;ccxKXXXXKo;;;,,,,,,,,,,''';dKKKKK0K0KKKKKKK0000KKKKKKKd,.......'xKKKKKKKk;....''''''''''',,'.';.       
       ;ccxKXKKXKo;:;;:;;;,;,,,'';xKKKKKKK0KKOxdxO0KKKK00000KKKo.......;kKKKK0o:;'.....''''',,,;;,,'.';.       
       ,:;o0XKKK0c;::clll:;,,,'':kKKKKKK0KK0o,...'l0KK0K0KK00KKO:....',d0K0K0x;,'.......,:ok00000kl,.',.       
       ,c;cOXXKK0l,,l0XKKKk;'',lOKKKKKKKKK0d'.....'l0K0KKK00KKKKx,.'lO0KK0000000k;....'ckKKKKKKKKKKx;',        
       'c:ckKXKXXx:;c0XKXX0l',d0KKKKKKKKKKx,.......,dKK000000KKK0l.:kKKK000000KKk;...;x0KKKKKKKKKKKKd:'        
       .c:cxKXXXXk;,c0XKKK0l,:OKKKKKK00KKk:.........cOKK000K000KKk,;k000000000OOd'..;OKKKK0kdx0KKKKKxc'        
       .;;cdKXKKX0c,dKXKKKx,,oKKK0000KKK0l'...'.....;kKK0000000KKO:.,,cOKKKKOc,,'..,xKKKKOc'.'lOKKK0o;.        
       .:;;o0XKKX0lcOXKKX0l';kKKKKK0KKKKk;...........oKKKK00000KK0c...;kK0K0l'....'l0KKKk;..',o0KKKOc;.        
        ;::cxKXXXKO0KKKXKd;';xKKKKKK0KKOc............,xKK0KK000KKKl...:OKKK0c.....:OKKKOc,;lx0KKKKKd,,.        
        'c:cd0XXXXKKKKKXO:',;xKKKKK00K0o'.............c0KKKKKKK0KKd'..cOKKKO:....'dKK00000KKKKKKKOo'':.        
        .::co0XXXKKXXKKKK0o,'l0KK000KKx,.......'......;kKK0K000KKKo...lOKKKO:....,kKK000KKKKK0kdc,'.,:.        
         ;::ckXXXXXK00XKKKKx;'o0K00KK0c..........''...'oKK00000KK0c..'d0KKK0c....:OKK00K0Odlc;,,,:;.,:.        
         :l:cdKXXXXOcckXXKKKk;'cOKKKOl'..'..:xkd:'.....c0K00000KK0l..'dKK0K0l....:OKKKKOl'...'',oKk,,:.        
         ;l:cxKXXXX0o;cOXKKKKx,.;okd;......:OKKK0o'....,xKKK000KKO:..'d0K0K0l'...;kKKKKk,.....;dKKd,::         
         ,o::lOXXXX0l;;oKKKKK0c'''''..'''..c0KKKK0c....'oKKK00KK0x,..,dKKKK0l....'d0K0K0kl::lx0KXO:'lc         
         .o:;lkXXXXXx:;cOXKKK0o,'''''''....;kKK0KKx,....:0KK000K0d'..,dKKKK0l.....c0KK00KKKKKKKK0c..oc         
         .olcloxO00K0o::xKXKKXOc'''''.......;x0KKKk,....'xKK000K0l...'dKK0KKd,....'lOKKKKKKKKKOd:,''o:         
         .lkcllllccclc;,:ododxdc,''''........';okkc......c0K00KKx;....oKKKKKk;......;oxkOkkxo:;,,,';x,         
          :0dlclolcol:::::;,''',,'''''...................;kKK0K0l.....:odddo:'.........''''''''',,.:x'         
          .l0Oo:::::ccc:;:;,,'',,,,,'''..'...............'o0KKKx,......................'''''''''''.ok.         
            lXKo;,,,,;;;:;,;;;,,,,,,,,''''''..............,dKK0c.........................''',,;:oxkd,          
            '0Xd:,........'',:cc::::::;;;,,,''''.''........'cl;..........'...'''',,,,,;;::;:ccccl0x'           
            .xXxc:'.....     ........'',,;;;;:llllccc:;;;;,'.......'''''..'..............       'k;            
             .OKl;,........                                                                     cx.            
              oXd;,.....                                                                       .dd             
               'Od;,.....                                                                      .oc             
               .kk:;'...                                                                       .o;             
                 oKo;;,.....                                                                  .o,              
                 .cxl:;,......                                                               .l'               
                   .:ddc,,.......                                                         ..,c:.               
                      .';::;,......                                                 ....''..                   
                           ..,,,,'..... ...                                  ...,;:;,..                        
                                ....,,,'''''......           ...........',;,,''..                              
                                         ....'''''',,;;;;:c:::;,,''....                                        
*/                                                                                                                

window.kafe = (function(w,d,$,undefined){

	// _exists (name)
	// check if module imported
	function _exists(name) {
		try {
			return eval("("+name+" != undefined)");
		} catch(e) {
			return false;
		}
	};

	// native extensions
	var _Native = {};
	 


	//-------------------------------------------
	// CORE
	//-------------------------------------------
	var core = {};
	core.kafe = '';
	
	//-------------------------------------------
	// FN
	//-------------------------------------------
	core.fn  = (function(){
		var fn = {};
		
		// setReadOnlyProperties (object, properties)
		// force readonly properties if possible
		//-------------------------------------------
		fn.setReadOnlyProperties = function (o,p) {
			eval("var o=arguments[0], p=arguments[1];");
			for (var i in p) {
				try {
					eval("o.__defineGetter__('"+i+"', function(){ return p['"+i+"']; });");
				} catch (e) {
					try {
						eval("Object.defineProperty(o, '"+i+"', {get:function(){ return p['"+i+"']; }});");
					} catch (e) {
						o[i] = p[i];
					}
				}
			}
		};
		
		// lang (dict,[lang])
		// get a existing lang
		//-------------------------------------------
		fn.lang = function(dict,lang) {
			lang = (!!lang) ? lang : core.env('lang');
			return (!!dict[lang]) ? lang : 'en';
		};
	
		return fn;
	})();

	var _coreReadOnly = core.fn.setReadOnlyProperties;

	
	// identification
	var _i = {};
	_coreReadOnly(_i = {}, {
		non:    'kafe',
		vesyon: '1.5-dev',
		griyaj: 'absolunet.com'
	});
	_coreReadOnly(core,{kafe: _i.vesyon});
	_coreReadOnly(core,{idantite:_i});
	_coreReadOnly(core,{vesyon:{}});


	// bonify (name/version/object)
	// add module to core
	//-------------------------------------------
	core.bonify = function(options) {
		
		// if not already extended
		var oname     = options.name; 
		var name      = 'this.'+oname; 
		var obj       = options.obj; 
		var objNative = obj.Native; 
		
		if (!_exists('core.'+oname)) {

			// if has Native methods
			if (objNative != undefined) {
				var 
					type           = oname.split('.')[0].replace(/^\w/, function($0) { return $0.toUpperCase(); }),
					isNativeObject = !!(':Array:Boolean:Date:Number:String:RegExp:'.search(new RegExp('\:'+type+'\:')) != -1),
					isNativeModule = !!(':Math:Window:Navigator:Screen:History:Location:Document:'.search(new RegExp('\:'+type+'\:')) != -1)						
				;
				
				// if object
				if (isNativeObject) {

					var sub = oname.split('.');
					
					// if subclass
					if (sub.length > 1) {
						sub.shift();
						sub = sub.join('_') + '_';
						
					// if not
					} else {
						sub = '';
						_Native[type] = function(o) { this.get = function(){return o;}; };
						w[type].prototype.K = function() { return new _Native[type](this); };
					}

					// push methods
					for (var i in objNative) {
						_Native[type].prototype[sub+i] = objNative[i];
					}

				
				
				// if module
				} else if (isNativeModule) {
					var sub = oname.split('.');
					
					// if subclass
					if (sub.length > 1) {
						sub.shift();
						sub = sub.join('_') + '_';
					} else {
						sub = '';
						w[type].K = {};
					}
					
					// push methods
					for (var i in objNative) {
						w[type].K[sub+i] = objNative[i];
					}
				}

				// delete local reference
				delete arguments[0].obj.Native;
			}

			// add version
			var v = {};
			v[oname] = options.version;
			_coreReadOnly(core.vesyon,v);
			
			// extend
			eval(name+' = arguments[0].obj;');
			
		// throw error
		} else {
			throw core.error(new Error(_i.non+'.'+oname+' already exists'));
		}
	};
	
	// plug (name/version/object)
	// add a plugin
	//-------------------------------------------
	core.plug = function(options) {
		options.name = 'plugin.'+options.name;
		this.bonify(options);
	};

	// extend (name/version/object)
	// add an external plugin extension
	//-------------------------------------------
	core.extend = function(options) {
		options.name = 'ext.'+options.name;
		this.bonify(options);
	};

	// required (name_or_url)
	// check if required module is included
	//-------------------------------------------
	core.required = function(name) {
		if (name.substr(0,2) == '//') {

			var found = false;
			$('script').each(function(){
				if (new RegExp(name).test(this.src)) {
					found = true;
					return false;
				}
			});

			if (!found) {
				throw core.error(new Error('\'' + name+'\' is required'));
			}

		} else if (!_exists(name)) {
			throw core.error(new Error(name+' is required'));
		}
	};

	// log (text)
	// traces
	//-------------------------------------------
	core.log = function(t) {
		try {
			var node = d.getElementById('LOG');
			var hr = d.createElement('hr');
			var code = d.createElement('code');
			code.appendChild(d.createTextNode(t))
			node.appendChild(code);
			node.appendChild(hr);
		} catch (e) {
			try {
				console.log(t);
			} catch (e) {
				alert(t);
			}
		}
	};

	// error (error)
	// throw errors - kafe.error(new Error('barf'));
	//-------------------------------------------
	core.error = function(e) {
		var msg = ((!!e.description) ? e.description : e.message);
		e.description = e.message = '<'+_i.non+':erè> : '+ ((!!msg) ? msg : 'anonim');
		return ($.browser.msie && parseInt($.browser.version) == 8) ? new Error(e) : e;
	};





	//-------------------------------------------
	// ENV
	//-------------------------------------------
	core.env = (function(){

		core.required('cssua');

		// base vals
		var 
			_data = {
				culture: '',
				lang:    '',
				page:    '',
				tmpl:    '',
				dtc:     {}
			},
			_dtc       = [],
			_cssuaData = {},
			_ua        = navigator.userAgent.toLowerCase(),
			_de        = document.documentElement,
	       	_r_Mac                    = /\bmacintosh; */,
	        _r_MacIntelOsxWithVersion = /\bintel mac os x[\s]+(\d+(\.\d+)*)/,
	        _r_MacIntelOsxGeneric     = /\bintel mac os x;*/,
	        _r_MacPpcOsxWithVersion   = /\bppc mac os x[\s]+(\d+(\.\d+)*)/,
	        _r_MacPpcOsxGeneric       = /\bppc mac os x;*/,
	        _r_Windows                = /\bwindows */,
	        _r_Linux                  = /\bx11; */
		;

		// grab kafe env
		_data.culture = _de.id.toLowerCase()   || '';
		_data.lang    = _de.lang.toLowerCase() || '';
		_data.page    = _de.getAttribute('data-kafe-page') || '';
		_data.tmpl    = _de.getAttribute('data-kafe-tmpl') || '';

		// os check via cssua
		if (_ua.match(_r_Windows)) {
			_cssuaData.pc = 'windows';
		
		} else if (_ua.match(_r_Linux)) {
			_cssuaData.pc = 'linux';
		
		} else if (_ua.match(_r_Mac)) {
		
			if (_ua.match(_r_MacIntelOsxWithVersion)) {
				_cssuaData.mac   = 'intel';
				_r_MacIntelOsxWithVersion.exec(_ua);
				_cssuaData.macos = RegExp.$1;
		
			} else if (_ua.match(_r_MacIntelOsxGeneric)) {
				_cssuaData.mac = 'intel';
				_cssuaData.macos = '10';
		
			} else if (_ua.match(_r_MacPpcOsxWithVersion)) {
				_cssuaData.mac = 'ppc';
				_r_MacPpcOsxWithVersion.exec(_ua);
				_cssuaData.macos = RegExp.$1;
		
			} else if (_ua.match(_r_MacPpcOsxGeneric)) {
				_cssuaData.mac = 'ppc';
				_cssuaData.macos = '10';
			}
		}
		_de.className = _de.className.replace(/\bjs\b/g, '') + cssua.format(_cssuaData);

		// parse detections
		_dtc = _de.className || '';
		_dtc = _dtc.split(' ');
		if (!!_dtc.length) {
			for (var i in _dtc) {
				if (_dtc[i].substring(0,4) == 'dtc-') {
					_data.dtc[_dtc[i].substring(4).replace(/-/g,'_')] = true;
				} 
			}
		}

		// public method (name, [value])
		//-------------------------------------------
		return function(name, value) {
			var updatable = ':mobile-orientation:';

			// get
			if (value == undefined) {
				return _data[name];

			// already set 
			} else if (_data[name] != undefined && updatable.search(new RegExp('\:'+name+'\:')) == -1) {
				throw core.error(new Error(_i.non+'.env > property \''+name+'\' already defined'));

			// set
			} else {
				_data[name] = value;
			}
		};
	})();

	// namespace for plugins and extensions
	core.plugin = {};
	core.ext    = {};

	return core;

})(window,document,jQuery);





//-------------------------------------------
// patch ie8 and less for HTML5 
//-------------------------------------------
(function($){
	if ($.browser.msie && parseInt($.browser.version) < 9) {
		var html5 = "address|article|aside|audio|canvas|command|datalist|details|dialog|figure|figcaption|footer|header|hgroup|keygen|mark|meter|menu|nav|progress|ruby|section|time|video".split('|');
		for (var i=0; i<html5.length; ++i){
			document.createElement(html5[i]);
		}
	}

	$.fn.appendHTML5 = function(str) {
		if (typeof(console) != 'undefined') { console.log('<kafe:avètisman> : appendHTML5 obsoleted'); }
		$(this[0]).append(str);
	    return this;
	}
})(jQuery);	
